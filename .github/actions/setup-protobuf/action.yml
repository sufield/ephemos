name: 'Setup Protocol Buffers'
description: 'Install protobuf compiler, Go protobuf tools, and generate protobuf files'
runs:
  using: 'composite'
  steps:
    - name: Install Protocol Buffers compiler (Ubuntu)
      if: runner.os == 'Linux'
      shell: bash
      run: |
        echo "Installing protobuf compiler for Ubuntu..."
        sudo apt-get update && sudo apt-get install -y protobuf-compiler
        echo "Verifying protoc installation..."
        export PATH="$PATH:/usr/bin"
        which protoc || (echo "‚ùå protoc not found" && exit 1)
        protoc --version || (echo "‚ùå protoc version check failed" && exit 1)
        echo "‚úÖ protoc installed at: $(which protoc)"
        
    - name: Install Protocol Buffers compiler (macOS)
      if: runner.os == 'macOS'
      shell: bash
      run: |
        echo "Installing protobuf compiler for macOS..."
        brew install protobuf
        echo "Verifying protoc installation..."
        which protoc || (echo "‚ùå protoc not found" && exit 1)
        protoc --version || (echo "‚ùå protoc version check failed" && exit 1)
        echo "‚úÖ protoc installed at: $(which protoc)"
        
    - name: Install Protocol Buffers compiler (Windows)
      if: runner.os == 'Windows'
      shell: bash
      run: |
        echo "Installing protobuf compiler for Windows..."
        choco install protoc
        echo "Verifying protoc installation..."
        which protoc || (echo "‚ùå protoc not found" && exit 1)
        protoc --version || (echo "‚ùå protoc version check failed" && exit 1)
        echo "‚úÖ protoc installed at: $(which protoc)"
        
    - name: Install Go protobuf tools
      shell: bash
      run: |
        echo "Installing Go protobuf tools..."
        
        # Ensure Go is working properly
        go version
        go env GOPATH
        
        # Install protobuf tools
        echo "Installing protoc-gen-go..."
        go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
        
        echo "Installing protoc-gen-go-grpc..."
        go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
        
        # Add Go bin to PATH for current and future steps
        GOPATH_BIN="$(go env GOPATH)/bin"
        export PATH="$PATH:$GOPATH_BIN"
        echo "$GOPATH_BIN" >> $GITHUB_PATH
        
        echo "Go tools installed at: $GOPATH_BIN"
        echo "Current PATH: $PATH"
        
        # Verify installations with explicit path
        echo "Verifying protoc-gen-go installation..."
        if [ -f "$GOPATH_BIN/protoc-gen-go" ]; then
          echo "‚úÖ protoc-gen-go found at $GOPATH_BIN/protoc-gen-go"
        else
          echo "‚ùå protoc-gen-go not found at $GOPATH_BIN/protoc-gen-go"
          ls -la "$GOPATH_BIN/" || echo "Go bin directory not found"
          exit 1
        fi
        
        echo "Verifying protoc-gen-go-grpc installation..."
        if [ -f "$GOPATH_BIN/protoc-gen-go-grpc" ]; then
          echo "‚úÖ protoc-gen-go-grpc found at $GOPATH_BIN/protoc-gen-go-grpc"
        else
          echo "‚ùå protoc-gen-go-grpc not found at $GOPATH_BIN/protoc-gen-go-grpc"
          ls -la "$GOPATH_BIN/" || echo "Go bin directory not found"
          exit 1
        fi
        
    - name: Verify all tools are available
      shell: bash
      run: |
        echo "Final verification of all protobuf tools..."
        # Ensure Go bin directory is in PATH
        GOPATH_BIN="$(go env GOPATH)/bin"
        export PATH="$PATH:$GOPATH_BIN:/usr/bin:/usr/local/bin"
        echo "PATH is: $PATH"
        
        echo "Checking protoc..."
        which protoc || (echo "‚ùå protoc not found in PATH" && exit 1)
        protoc --version || (echo "‚ùå protoc version check failed" && exit 1)
        
        echo "Checking protoc-gen-go..."
        which protoc-gen-go || (echo "‚ùå protoc-gen-go not found" && exit 1)
        
        echo "Checking protoc-gen-go-grpc..."
        which protoc-gen-go-grpc || (echo "‚ùå protoc-gen-go-grpc not found" && exit 1)
        
        echo "‚úÖ All protobuf tools verified successfully"
        
    - name: Generate protobuf code
      shell: bash
      run: |
        echo "Generating protobuf code (REQUIRED for CI/CD)..."
        # Ensure Go bin directory is in PATH
        GOPATH_BIN="$(go env GOPATH)/bin"
        export PATH="$PATH:$GOPATH_BIN:/usr/bin:/usr/local/bin"
        
        echo "Current working directory: $(pwd)"
        echo "Repository root contents:"
        ls -la . | head -10
        echo ""
        echo "Checking examples directory..."
        ls -la examples/ || echo "Examples directory not found"
        echo ""
        echo "Checking proto directory..."
        ls -la examples/proto/ || echo "Proto directory not found"
        echo ""
        echo "Git status check for proto file:"
        git ls-files examples/proto/echo.proto || echo "Proto file not tracked in git"
        
        # Check if proto file exists
        if [ ! -f "examples/proto/echo.proto" ]; then
          echo "‚ùå Source proto file examples/proto/echo.proto not found"
          echo "Working directory: $(pwd)"
          echo "Full directory listing:"
          find . -name "echo.proto" -o -name "*.proto" 2>/dev/null || echo "No proto files found"
          
          # Create a minimal fallback proto file
          echo "‚ö†Ô∏è Creating fallback echo.proto file for CI..."
          mkdir -p examples/proto
          {
            echo 'syntax = "proto3";'
            echo ''
            echo 'package ephemos.echo;'
            echo ''
            echo 'option go_package = "github.com/sufield/ephemos/examples/proto";'
            echo ''
            echo '// EchoService provides a simple echo functionality for testing.'
            echo 'service EchoService {'
            echo '  rpc Echo(EchoRequest) returns (EchoResponse);'
            echo '}'
            echo ''
            echo 'message EchoRequest {'
            echo '  string message = 1;'
            echo '}'
            echo ''
            echo 'message EchoResponse {'
            echo '  string message = 1;'
            echo '  string from = 2;'
            echo '}'
          } > examples/proto/echo.proto
          echo "‚úÖ Fallback echo.proto created"
        fi
        
        # Force regeneration of protobuf files
        echo "Removing any existing protobuf files..."
        rm -f examples/proto/*.pb.go
        
        echo "Generating fresh protobuf files..."
        echo "PATH: $PATH"
        echo "GOPATH: $(go env GOPATH)"
        echo "Available tools:"
        which protoc || echo "protoc not found"
        which protoc-gen-go || echo "protoc-gen-go not found"  
        which protoc-gen-go-grpc || echo "protoc-gen-go-grpc not found"
        
        # Try make proto first
        if ! make proto; then
          echo "‚ö†Ô∏è make proto failed, trying direct protoc invocation..."
          # Fallback to direct protoc call
          if ! protoc \
            --go_out=examples/proto \
            --go_opt=paths=source_relative \
            --go-grpc_out=examples/proto \
            --go-grpc_opt=paths=source_relative \
            -I examples/proto \
            examples/proto/echo.proto; then
            echo "‚ùå Both make proto and direct protoc failed"
            exit 1
          fi
        fi
        
        # Verify files were generated
        if [ ! -f "examples/proto/echo.pb.go" ] || [ ! -f "examples/proto/echo_grpc.pb.go" ]; then
          echo "‚ùå Protobuf files were not generated successfully"
          echo "Directory contents:"
          ls -la examples/proto/
          exit 1
        fi
        
        echo "‚úÖ Protobuf code generated successfully"
        echo "Generated files:"
        ls -la examples/proto/*.pb.go
        
    - name: Clear Go build cache after protobuf generation
      shell: bash  
      run: |
        echo "üßπ Clearing Go build cache after protobuf generation..."
        go clean -cache || true
        go clean -testcache || true
        echo "‚úÖ Build cache cleared to prevent stale module issues"