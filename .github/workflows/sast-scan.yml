name: SAST Scan with ShiftLeft

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run additional SAST scans every Tuesday at 2:00 AM UTC (complement CodeQL on Monday)
    - cron: '0 2 * * 2'

env:
  SCAN_WORKSPACE: "https://github.com/sufield/ephemos"

# Restrict permissions for security - only read access needed for SAST scanning
permissions:
  contents: read

jobs:
  scan:
    name: ShiftLeft Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      # PR path: checkout the fork + branch that opened the PR
      - name: Checkout PR head
        if: github.event_name == 'pull_request'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}

      # Push path: checkout this repo/branch
      - name: Checkout push ref
        if: github.event_name != 'pull_request'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.ref }}

      - name: Set up Go
        uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0da7ef32 # v5.0.2
        with:
          go-version: '1.23'
          check-latest: false  # Disable to avoid toolchain download timeouts

      - name: Download dependencies
        run: go mod download

      - name: Create reports directory
        run: mkdir -p reports/

      - name: Perform ShiftLeft Security Scan
        uses: ShiftLeftSecurity/scan-action@master
        with:
          type: "credscan,go,depscan"  # credscan for secrets, go for SAST on Go code, depscan for dependencies
        env:
          WORKSPACE: ${{ env.SCAN_WORKSPACE }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SCAN_AUTO_BUILD: true

      - name: Upload scan reports
        if: always()  # Upload even if scan fails
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: shiftleft-scan-reports
          path: reports/
          retention-days: 30

      # Optional: Convert results to SARIF and upload to GitHub Security tab
      - name: Upload SARIF results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@e2b3eafc8d227b0241d48be5f425d47c2d750a13 # v3.26.10
        with:
          sarif_file: reports/result.sarif
        continue-on-error: true