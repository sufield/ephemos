# Core Makefile for Ephemos
# Handles essential build, test, and development tasks

# Build variables for reproducible builds
VERSION ?= $(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")
COMMIT_HASH ?= $(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")
BUILD_TIME ?= $(shell date -u +"%Y-%m-%dT%H:%M:%SZ")
BUILD_USER ?= $(shell whoami)
BUILD_HOST ?= $(shell hostname)

# Go build flags for reproducible builds
LDFLAGS := -X main.Version=$(VERSION) \
           -X main.CommitHash=$(COMMIT_HASH) \
           -X main.BuildTime=$(BUILD_TIME) \
           -X main.BuildUser=$(BUILD_USER) \
           -X main.BuildHost=$(BUILD_HOST)

GO_BUILD_FLAGS := -trimpath -ldflags "$(LDFLAGS)"

# Variables
PROTO_DIR := examples/proto
GO_OUT := examples/proto
CLI_BINARY := ephemos
SERVER_BINARY := echo-server
CLIENT_BINARY := echo-client
CONFIG_VALIDATOR_BINARY := config-validator

# PHONY targets - all targets that don't create files
.PHONY: all build proto proto-ci examples test clean deps fmt lint help setup \
        check-deps install-deps install-deps-sudo benchmark fmt-only core-help version show-build-info

# Default target
all: proto build examples

# Build library and CLI with reproducible builds
build: check-deps show-build-info
	@echo "Building Ephemos CLI with reproducible build flags..."
	@mkdir -p bin
	go build $(GO_BUILD_FLAGS) -v -o "bin/$(CLI_BINARY)" ./cmd/ephemos-cli
	go build $(GO_BUILD_FLAGS) -v -o "bin/$(CONFIG_VALIDATOR_BINARY)" ./cmd/config-validator
	@echo "Build completed!"
	@echo "Binaries built with version: $(VERSION)"

# Generate protobuf code
proto: check-deps
	@echo "Generating protobuf code..."
	@mkdir -p "$(GO_OUT)"
	@./scripts/build/generate-proto.sh "$(PROTO_DIR)" "$(GO_OUT)"

# CI-friendly protobuf generation (doesn't fail on missing protoc)
proto-ci:
	@echo "Generating protobuf code (CI mode)..."
	@mkdir -p "$(GO_OUT)"
	@./scripts/generate-proto-ci.sh "$(PROTO_DIR)" "$(GO_OUT)" || { \
		echo "âš ï¸  Protobuf generation failed in CI mode"; \
		echo "ğŸ’¡ This might be expected in some CI environments"; \
		echo "ğŸ’¡ Ensure your CI setup includes protoc installation"; \
		exit 0; \
	}

# Build example applications with reproducible builds
examples: proto
	@echo "Building example applications with reproducible build flags..."
	@mkdir -p bin
	go build $(GO_BUILD_FLAGS) -v -o "bin/$(SERVER_BINARY)" ./examples/echo-server
	go build $(GO_BUILD_FLAGS) -v -o "bin/$(CLIENT_BINARY)" ./examples/echo-client
	@echo "Examples built with version: $(VERSION)"

# Run tests
test: check-deps
	@echo "Running tests..."
	go test -v ./...
	@echo "Tests completed!"

# Run benchmarks
benchmark: check-deps
	@echo "Running benchmarks..."
	@./scripts/benchmark.sh

# Get dependencies
deps:
	@echo "Getting dependencies..."
	go mod download
	go mod tidy
	@echo "Dependencies updated!"

# Format code
fmt:
	@echo "Formatting code..."
	go fmt ./...
	@echo "Code formatted!"

# Lint code
lint:
	@echo "Linting code..."
	@./scripts/build/lint.sh
	@echo "Linting completed!"

# Format code only (no build validation)
fmt-only:
	@echo "Formatting code..."
	@./scripts/build/lint-format-only.sh
	@echo "Formatting completed!"

# Clean build artifacts
clean:
	@echo "Cleaning build artifacts..."
	rm -rf bin/
	rm -f "$(GO_OUT)"/*.pb.go
	@echo "Clean completed!"

# Show build information
show-build-info:
	@echo "Build Information:"
	@echo "=================="
	@echo "Version:     $(VERSION)"
	@echo "Commit:      $(COMMIT_HASH)"
	@echo "Build Time:  $(BUILD_TIME)"
	@echo "Build User:  $(BUILD_USER)"
	@echo "Build Host:  $(BUILD_HOST)"
	@echo "Go Flags:    $(GO_BUILD_FLAGS)"
	@echo ""

# Show version only
version:
	@echo "$(VERSION)"

# Help
core-help:
	@echo "Core Ephemos Build Targets:"
	@echo ""
	@echo "Build targets (with reproducible builds):"
	@echo "  make build          - Build library and CLI with version info"
	@echo "  make examples       - Build example applications with version info"
	@echo "  make clean          - Clean build artifacts"
	@echo ""
	@echo "Development targets:"
	@echo "  make setup          - Smart setup (checks deps, installs Go tools)"
	@echo "  make install-deps   - Install Go tools only (no sudo required)"
	@echo "  make install-deps-sudo - Install all deps including system packages (requires sudo)"
	@echo "  make check-deps     - Check if all dependencies are installed"
	@echo "  make test           - Run tests"
	@echo "  make benchmark      - Run benchmarks"
	@echo "  make deps           - Get/update Go dependencies"
	@echo "  make fmt            - Format code"
	@echo "  make fmt-only       - Format code only (no validation)"
	@echo "  make lint           - Lint code"
	@echo ""
	@echo "Protobuf targets:"
	@echo "  make proto          - Generate protobuf code"
	@echo "  make proto-ci       - Generate protobuf code (CI-friendly)"
	@echo ""
	@echo "Information targets:"
	@echo "  make version        - Show version"
	@echo "  make show-build-info- Show detailed build information"
	@echo "  make help           - Show this help"

# Development setup targets
setup:
	@echo "ğŸ”§ Setting up Ephemos development environment..."
	@echo "==========================================="
	@if ./scripts/check-deps.sh; then \
		echo ""; \
		echo "ğŸ‰ All dependencies are already available!"; \
		echo "You can now run: make build"; \
	else \
		echo ""; \
		echo "ğŸ”§ Installing Go tools (no sudo required)..."; \
		if ./scripts/install-deps.sh; then \
			echo ""; \
			if ./scripts/check-deps.sh >/dev/null 2>&1; then \
				echo "ğŸ‰ Development environment setup complete!"; \
				echo "You can now run: make build"; \
			else \
				echo "ğŸ”§ Setup partially complete. System packages still needed."; \
				echo "For system packages (protoc), run: ./scripts/install-deps-sudo.sh"; \
				echo "Or install manually and run 'make setup' again"; \
			fi; \
		else \
			echo ""; \
			echo "âš ï¸  Go tools installation had issues."; \
			echo "Please check the output above and resolve any errors."; \
			echo "Then run 'make setup' again"; \
		fi; \
	fi

check-deps:
	@echo "ğŸ” Checking development dependencies..."
	@if ./scripts/check-deps.sh; then \
		echo "âœ… All dependencies available"; \
	else \
		echo ""; \
		echo "ğŸ”§ Missing dependencies detected. Installing Go tools automatically..."; \
		if ./scripts/ensure-protoc.sh; then \
			echo "âœ… Go protobuf tools installed successfully"; \
		else \
			echo ""; \
			echo "âš ï¸  Some dependencies missing. Build may fail."; \
			if [ "${CI:-}" = "true" ] || [ "${GITHUB_ACTIONS:-}" = "true" ]; then \
				echo "ğŸ’¡ CI detected: Check setup-protobuf action in GitHub workflow"; \
			else \
				echo "ğŸ’¡ Run 'make setup' for smart installation"; \
				echo "ğŸ’¡ Or run: ./scripts/install-deps-sudo.sh for system packages"; \
			fi; \
		fi; \
	fi

install-deps:
	@echo "ğŸ”§ Installing development dependencies..."
	@./scripts/install-deps.sh

# Install with sudo for system packages
install-deps-sudo:
	@echo "ğŸ”§ Installing development dependencies (with sudo)..."
	@./scripts/install-deps-sudo.sh